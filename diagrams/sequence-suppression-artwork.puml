@startuml Séquence Suppression Œuvre

!define PRIMARY_COLOR #4ECDC4
!define SECONDARY_COLOR #FF6B6B

skinparam backgroundColor #FAFAFA
skinparam sequenceParticipantBackgroundColor PRIMARY_COLOR

title Diagramme de Séquence - Suppression d'une Œuvre

actor Artiste as artist
participant "profile.php" as profile
participant "delete_artwork.php" as page
participant "db.php" as db_conn
database "MySQL\ngallery" as db
participant "File System\nuploads/" as fs

artist -> profile : Accède à profile.php
activate profile

profile -> profile : Vérifie $_SESSION['user_id']

profile -> db_conn : require db.php
activate db_conn
db_conn -> db : Connexion MySQL
db --> db_conn : $conn
deactivate db_conn

profile -> db : SELECT id FROM artists\nWHERE user_id = ?
activate db
db --> profile : artist_id
deactivate db

profile -> db : SELECT * FROM artworks\nWHERE artist_id = ?
activate db
db --> profile : [artworks...]
deactivate db

profile --> artist : Affiche liste des œuvres

artist -> profile : Clique "Delete"\nsur une œuvre

profile -> page : Redirige vers\ndelete_artwork.php?id={id}
activate page

page -> page : Vérifie $_SESSION['user_id']\net $_SESSION['role'] === 'artist'
activate api

api -> auth : Vérifie JWT token

page -> db_conn : require db.php
activate db_conn
db_conn -> db : Connexion MySQL
db --> db_conn : $conn
deactivate db_conn

page -> db : SELECT id FROM artists\nWHERE user_id = ?
activate db
db --> page : artist_id
deactivate db

page -> db : SELECT image_path\nFROM artworks\nWHERE id = ?\nAND artist_id = ?
activate db

alt Œuvre non trouvée ou non propriétaire
    db --> page : 0 rows
    page --> artist : header('Location: profile.php')
else Œuvre trouvée et propriétaire
    db --> page : artwork {image_path}
    deactivate db
    
    page -> db : DELETE FROM artworks\nWHERE id = ?\nAND artist_id = ?
    activate db
    db --> page : Supprimé
    deactivate db
    
    page -> fs : unlink(image_path)
    activate fs
    
    alt Erreur suppression fichier
        fs --> page : false
        note right
            Continue quand même,
            l'œuvre est supprimée de DB
        end note
    else Fichier supprimé
        fs --> page : true
    end
    deactivate fs
    
    page --> artist : "Artwork deleted"
    page -> page : header('Location: profile.php')
    deactivate page
    
    artist -> profile : Redirigé vers profile.php
end

note right of page
    Sécurité:
    - Vérification du propriétaire via artist_id
    - Suppression DB puis fichier
    - Redirection automatique après suppression
end note

@enduml
