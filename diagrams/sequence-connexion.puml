@startuml Séquence Connexion Utilisateur

!define PRIMARY_COLOR #4ECDC4
!define SECONDARY_COLOR #FF6B6B

skinparam backgroundColor #FAFAFA
skinparam sequenceParticipantBackgroundColor PRIMARY_COLOR

title Diagramme de Séquence - Connexion Utilisateur

actor Utilisateur as user
participant "login.php" as page
participant "db.php" as db_conn
database "MySQL\ngallery" as db

user -> page : Accède à login.php
activate page
page --> user : Affiche formulaire connexion

user -> page : Saisit email et password
user -> page : Clique "Se connecter"

page -> page : $_POST validation
page -> db_conn : require db.php
activate db_conn
db_conn -> db : Connexion MySQL
db --> db_conn : $conn
deactivate db_conn

page -> db : SELECT id, password_hash, role\nFROM users WHERE email = ?
activate db

alt Utilisateur non trouvé
    db --> page : 0 rows
    page --> user : "Invalid email or password"
else Utilisateur trouvé
    db --> page : user data
    deactivate db
    
    page -> page : password_verify()
    
    alt Mot de passe incorrect
        controller --> api : 401 Unauthorized
        api --> page : Identifiants invalides
        page --> user : "Email ou mot de passe incorrect"
    else Mot de passe correct
        controller -> controller : Génère JWT token\n{userId, email, role}
        
        controller --> api : 200 OK\n{token, user: {id, username, email, role}}
        deactivate controller
    
    alt Mot de passe incorrect
        page --> user : "Invalid email or password"
    else Mot de passe correct
        page -> page : $_SESSION['user_id'] = user_id
        page -> page : $_SESSION['role'] = role
        
        page --> user : Connexion réussie
        page -> page : header('Location: index.php')
        deactivate page
        
        user -> page : Redirigé vers index.php (Gallery)
        
        note right of page
            Session PHP utilisée pour
            l'authentification. Les variables
            $_SESSION persistent entre les pages
        end note
    end
end

@enduml
