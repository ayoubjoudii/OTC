@startuml Séquence Inscription Utilisateur

!define PRIMARY_COLOR #4ECDC4
!define SECONDARY_COLOR #FF6B6B

skinparam backgroundColor #FAFAFA
skinparam sequenceParticipantBackgroundColor PRIMARY_COLOR
skinparam sequenceLifeLineBackgroundColor #FFFFFF

title Diagramme de Séquence - Inscription Utilisateur

actor Utilisateur as user
participant "register.php" as page
participant "db.php" as db_conn
database "MySQL\ngallery" as db

user -> page : Accède à register.php
activate page
page --> user : Affiche formulaire inscription

user -> page : Remplit formulaire\n(email, password, password2)
user -> page : Clique "S'inscrire"

page -> page : Validation côté serveur\n(filter_var, strlen, match)
alt Validation échoue
    page --> user : Affiche erreurs formulaire
else Validation réussie
    page -> db_conn : require db.php
    activate db_conn
    db_conn -> db : Connexion MySQL
    db --> db_conn : $conn
    deactivate db_conn
    
    page -> db : SELECT id FROM users\nWHERE email = ?
    activate db
    
    alt Email déjà utilisé
            db --> controller : Utilisateur trouvé
            controller --> api : Erreur "Email déjà utilisé"
            api --> page : 409 Conflict
            page --> user : "Email déjà utilisé"
        else Email disponible
            db --> controller : Aucun utilisateur
            
            controller -> controller : Hash password (bcrypt)
            controller -> db : Créer utilisateur
            db --> controller : Utilisateur créé
            deactivate db
            
        db --> page : Email existe déjà
        page --> user : "Email already registered"
    else Email disponible
        db --> page : OK
        deactivate db
        
        page -> page : password_hash($password,\nPASSWORD_DEFAULT)
        
        page -> db : INSERT INTO users\n(email, password_hash)\nVALUES (?, ?)
        activate db
        db --> page : User créé (insert_id)
        deactivate db
        
        page -> page : $_SESSION['user_id'] = insert_id
        page -> page : $_SESSION['role'] = 'user'
        
        page --> user : Succès - Auto-login
        page -> page : header('Location: index.php')
        deactivate page
        
        user -> page : Redirigé vers index.php (Gallery)
    end
end

@enduml
