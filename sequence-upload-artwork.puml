@startuml Séquence Upload Œuvre d'Art

!define PRIMARY_COLOR #4ECDC4
!define SECONDARY_COLOR #FF6B6B

skinparam backgroundColor #FAFAFA
skinparam sequenceParticipantBackgroundColor PRIMARY_COLOR

title Diagramme de Séquence - Upload d'une Œuvre d'Art

actor Artiste as artist
participant "Page\nUpload" as page
participant "API\nBackend" as api
participant "Middleware\nAuth" as auth
participant "Multer" as multer
participant "Controller\nArtwork" as controller
database "MongoDB" as db
participant "File System" as fs

artist -> page : Accède à /upload-artwork
activate page

page -> api : Vérifie authentification
activate api
api -> auth : Vérifie JWT token
activate auth

alt Token invalide/absent
    auth --> api : 401 Unauthorized
    api --> page : Non authentifié
    page --> artist : Redirection vers /login
else Token valide
    auth --> api : User authentifié
    deactivate auth
    api --> page : OK
    deactivate api
    
    page --> artist : Affiche formulaire upload
    
    artist -> page : Remplit formulaire\n(title, artist, year, description, category)
    artist -> page : Sélectionne image
    artist -> page : Clique "Uploader"
    
    page -> api : POST /api/artworks\n(multipart/form-data)\n+ JWT token
    activate api
    
    api -> auth : Vérifie JWT token
    activate auth
    auth --> api : User authentifié
    deactivate auth
    
    api -> multer : Upload fichier image
    activate multer
    
    alt Fichier invalide (type/taille)
        multer --> api : Erreur validation fichier
        api --> page : 400 Bad Request\n"Format ou taille invalide"
        page --> artist : Affiche erreur
    else Fichier valide
        multer -> fs : Sauvegarde image\ndans /uploads/
        activate fs
        fs --> multer : Chemin fichier
        deactivate fs
        multer --> api : Upload réussi\n{filename, path}
        deactivate multer
        
        api -> controller : createArtwork(req, res)
        activate controller
        
        controller -> controller : Validation données\n(title, artist, year, etc.)
        
        alt Validation échoue
            controller -> fs : Supprime fichier uploadé
            controller --> api : 400 Bad Request
            api --> page : Erreurs validation
            page --> artist : Affiche erreurs
        else Validation réussie
            controller -> db : Créer document artwork\n{title, artist, year, description,\ncategory, imageUrl, owner: userId}
            activate db
            
            db --> controller : Artwork créé
            deactivate db
            
            controller --> api : 201 Created\n{artwork}
            deactivate controller
            
            api --> page : {artwork}
            deactivate api
            
            page --> artist : Succès - Œuvre ajoutée
            deactivate page
            
            artist -> page : Redirigé vers /gallery\nou /my-artworks
        end
    end
end

note right of multer
    Multer configuration:
    - Formats: JPG, PNG, WebP
    - Taille max: 5MB
    - Destination: ./uploads/
    - Filename: timestamp-originalname
end note

@enduml
